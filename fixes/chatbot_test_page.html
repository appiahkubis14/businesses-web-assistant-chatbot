<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .logs {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            margin-bottom: 20px;
        }
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #007cba;
            color: white;
        }
        button:hover {
            background: #005a87;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chatbot Fix Testing Page</h1>
        
        <div id="status" class="status">
            <h3>Status: Initializing...</h3>
            <p id="statusText">Loading chatbot widget...</p>
        </div>

        <div class="test-buttons">
            <button onclick="testBasicMessage()">Test Basic Message</button>
            <button onclick="testMultipleMessages()">Test Multiple Messages</button>
            <button onclick="testWebSocketConnection()">Test WebSocket</button>
            <button onclick="testErrorHandling()">Test Error Handling</button>
            <button onclick="clearLogs()">Clear Logs</button>
            <button onclick="resetChatbot()">Reset Chatbot</button>
        </div>

        <div id="logs" class="logs"></div>

        <div>
            <h3>Test Instructions:</h3>
            <ol>
                <li><strong>Basic Message Test:</strong> Sends a test message and verifies response</li>
                <li><strong>Multiple Messages:</strong> Sends several messages in sequence</li>
                <li><strong>WebSocket Test:</strong> Checks WebSocket connection status</li>
                <li><strong>Error Handling:</strong> Tests error scenarios</li>
            </ol>
            
            <h3>Expected Behavior (Fixed):</h3>
            <ul>
                <li>âœ… Messages appear immediately after sending</li>
                <li>âœ… Auto-response from bot appears within 1-2 seconds</li>
                <li>âœ… Typing indicator disappears after response</li>
                <li>âœ… Multiple messages can be sent without issues</li>
                <li>âœ… WebSocket connection shows as "Online"</li>
                <li>âœ… No console errors related to message handling</li>
            </ul>
        </div>
    </div>

    <!-- Configure chatbot -->
    <script>
        window.ChatBotConfig = {
            apiUrl: 'http://172.20.10.2:5000',
            websiteId: 'test-website-uuid-12345', // Replace with actual UUID
            theme: 'green',
            position: 'bottom-right',
            botName: 'Test Assistant',
            welcomeMessage: "Hi! I'm your test assistant. Send me a message to test the fixes!",
            enableSound: false, // Disable for testing
            showTypingIndicator: true,
            maxMessages: 50,
            autoConnect: true,
            showAvatar: true,
            allowMinimize: true,
            allowClose: true
        };
    </script>

    <!-- Load the fixed chatbot widget -->
    <script src="chatbot_widget_fixed.js"></script>

    <script>
        let logContainer, statusContainer, statusText;
        let testResults = [];
        let chatbotInstance;

        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('logs');
            statusContainer = document.getElementById('status');
            statusText = document.getElementById('statusText');

            // Initialize chatbot
            try {
                chatbotInstance = window.initChatBot(window.ChatBotConfig);
                log('âœ… Chatbot initialized successfully');
                updateStatus('success', 'Chatbot Ready', 'Chatbot widget loaded and ready for testing');
                
                // Test basic functionality after initialization
                setTimeout(() => {
                    checkChatbotStatus();
                }, 2000);
                
            } catch (error) {
                log('âŒ Failed to initialize chatbot: ' + error.message);
                updateStatus('error', 'Initialization Failed', error.message);
            }
        });

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }

        function updateStatus(type, title, message) {
            statusContainer.className = `status ${type}`;
            statusContainer.querySelector('h3').textContent = `Status: ${title}`;
            statusText.textContent = message;
        }

        function checkChatbotStatus() {
            try {
                if (chatbotInstance) {
                    log('âœ… Chatbot instance exists');
                    log(`ðŸ”— WebSocket connected: ${chatbotInstance.isConnected}`);
                    log(`ðŸ“ Messages count: ${chatbotInstance.messages.length}`);
                    log(`ðŸ  Website ID: ${chatbotInstance.websiteId}`);
                    log(`ðŸ’¬ Conversation ID: ${chatbotInstance.conversationId || 'Not yet created'}`);
                } else {
                    log('âŒ Chatbot instance not found');
                }
            } catch (error) {
                log('âŒ Error checking chatbot status: ' + error.message);
            }
        }

        function testBasicMessage() {
            log('\nðŸ§ª Starting Basic Message Test...');
            try {
                if (!chatbotInstance) {
                    log('âŒ Chatbot not initialized');
                    return;
                }

                // Open chatbot if closed
                chatbotInstance.open();
                log('ðŸ“± Opened chatbot widget');

                // Simulate sending a message
                setTimeout(() => {
                    const input = document.getElementById('chatbot-input');
                    if (input) {
                        input.value = 'Hello! This is a test message.';
                        log('âœï¸ Entered test message');
                        
                        // Trigger form submission
                        const form = document.getElementById('chatbot-form');
                        if (form) {
                            form.dispatchEvent(new Event('submit'));
                            log('ðŸ“¤ Submitted message form');
                            
                            // Check for response
                            setTimeout(() => {
                                const messageCount = chatbotInstance.messages.length;
                                log(`ðŸ“Š Total messages: ${messageCount}`);
                                log(`ðŸ”„ Loading state: ${chatbotInstance.isLoading}`);
                                
                                if (!chatbotInstance.isLoading) {
                                    log('âœ… Basic Message Test: PASSED - Loading state cleared');
                                } else {
                                    log('âŒ Basic Message Test: FAILED - Still in loading state');
                                }
                            }, 3000);
                        } else {
                            log('âŒ Form not found');
                        }
                    } else {
                        log('âŒ Input field not found');
                    }
                }, 1000);

            } catch (error) {
                log('âŒ Basic Message Test Error: ' + error.message);
            }
        }

        function testMultipleMessages() {
            log('\nðŸ§ª Starting Multiple Messages Test...');
            let messageCount = 0;
            const maxMessages = 3;

            function sendNextMessage() {
                if (messageCount >= maxMessages) {
                    log('âœ… Multiple Messages Test: COMPLETED');
                    return;
                }

                messageCount++;
                const input = document.getElementById('chatbot-input');
                const form = document.getElementById('chatbot-form');

                if (input && form && !chatbotInstance.isLoading) {
                    input.value = `Test message ${messageCount} of ${maxMessages}`;
                    form.dispatchEvent(new Event('submit'));
                    log(`ðŸ“¤ Sent message ${messageCount}/${maxMessages}`);
                    
                    // Wait for response before sending next
                    setTimeout(sendNextMessage, 4000);
                } else if (chatbotInstance.isLoading) {
                    log(`â³ Waiting for previous message to complete...`);
                    setTimeout(sendNextMessage, 1000);
                } else {
                    log('âŒ Cannot send message - form elements not found');
                }
            }

            sendNextMessage();
        }

        function testWebSocketConnection() {
            log('\nðŸ§ª Starting WebSocket Connection Test...');
            try {
                if (chatbotInstance.socket) {
                    log(`ðŸ”— WebSocket state: ${chatbotInstance.socket.readyState}`);
                    log(`ðŸŒ WebSocket URL: ${chatbotInstance.socket.url}`);
                    log(`âœ… Connected: ${chatbotInstance.isConnected}`);
                    
                    // Send ping
                    if (chatbotInstance.socket.readyState === WebSocket.OPEN) {
                        chatbotInstance.socket.send(JSON.stringify({ type: 'ping' }));
                        log('ðŸ“¡ Sent ping to server');
                    }
                } else {
                    log('âŒ WebSocket not initialized');
                }
            } catch (error) {
                log('âŒ WebSocket Test Error: ' + error.message);
            }
        }

        function testErrorHandling() {
            log('\nðŸ§ª Starting Error Handling Test...');
            try {
                // Test with invalid message
                if (chatbotInstance.socket && chatbotInstance.socket.readyState === WebSocket.OPEN) {
                    chatbotInstance.socket.send('invalid json');
                    log('ðŸ“¡ Sent invalid JSON to test error handling');
                }
                
                // Test loading state reset
                chatbotInstance.isLoading = true;
                chatbotInstance.updateWidget();
                log('ðŸ”„ Set loading state to true');
                
                setTimeout(() => {
                    chatbotInstance.handleError('Test error message');
                    log('ðŸ’¥ Triggered test error');
                    
                    setTimeout(() => {
                        if (!chatbotInstance.isLoading) {
                            log('âœ… Error Handling Test: PASSED - Loading state reset');
                        } else {
                            log('âŒ Error Handling Test: FAILED - Loading state not reset');
                        }
                    }, 1000);
                }, 1000);
                
            } catch (error) {
                log('âŒ Error Handling Test Error: ' + error.message);
            }
        }

        function clearLogs() {
            logContainer.textContent = '';
            log('ðŸ§¹ Logs cleared');
        }

        function resetChatbot() {
            log('\nðŸ”„ Resetting chatbot...');
            try {
                if (chatbotInstance) {
                    chatbotInstance.clearConversation();
                    log('âœ… Chatbot conversation cleared');
                    updateStatus('warning', 'Reset Complete', 'Chatbot has been reset and is ready for testing');
                }
            } catch (error) {
                log('âŒ Reset Error: ' + error.message);
            }
        }

        // Monitor chatbot events
        setInterval(() => {
            if (chatbotInstance) {
                const connectionStatus = chatbotInstance.isConnected ? 'Connected' : 'Disconnected';
                const loadingStatus = chatbotInstance.isLoading ? 'Loading' : 'Ready';
                document.title = `Chatbot Test - ${connectionStatus} - ${loadingStatus}`;
            }
        }, 5000);
    </script>
</body>
</html>
